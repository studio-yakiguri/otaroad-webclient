<!doctype html>
<html lang="ko" data-bs-theme="dark">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    @font-face {
      font-family: 'neodgm';
      src: url('../assets/fonts/neodgm.woff') format('woff');
      font-weight: normal;
      font-style: normal;
    }

    #nav-title {
      font-family: 'neodgm';
      font-size: 4em;
    }

    #map {
      width: auto;
      height: 45em;
    }

    #shop-list {
      background-color: white;
      height: 100%;
    }

    .info-window {
      color: black
    }

    #shopModalLabel {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    #loginModalLabel {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
  </style>
  <title>Subculture-Map</title>
</head>

<body>
  <!-- 부트스트랩 css-->
  <link href="css/bootstrap.css" rel="stylesheet">
  <!-- bootstrap js -->
  <script type="text/javascript" src="js/bootstrap.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- 카카오맵 js -->
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=54742a4e677242078bb4fcb2fba0fbaf"></script>
  <!--Twitter Widget-->
  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

  <!-- navibar -->
  <header class="d-flex flex-wrap align-items-center justify-content-center justify-content-md-between px-3 py-2 mb-4 text-center">
    <ul class="nav col-12 col-md-auto mb-2 justify-content-center mb-md-0">
      <li>
        <a href="https://discord.gg/BpXGUx89Nj" class="nav-link px-2" target="_blank">디스코드 채널</a>
      </li>
      <li>
        <a href="#" class="nav-link px-5">행사</a>
      </li>
      <li>
        <a href="#" class="nav-link px-2">About</a>
      </li>
    </ul>
    <h1 class=" col-md-auto display-5 text-body-emphasis p-auto m-auto" id="nav-title">Subculture Map</h1>
    <div class="col-md-1 text-end">
      <button type="button" class="btn btn-link" style="text-decoration: none" href="loginUrl" data-bs-toggle="modal"
        data-bs-target="#loginModal">로그인</button>
    </div>
  </header>

  <!-- MapSide -->
  <div id="data-side" class="container-fluid">
    <div class="row">
      <div class="col-sm-3">
        <!-- ShopListSide -->
        <ul id="shop-list" class="list-group" data-bs-theme="light">
          <li class="list-group-item active" aria-current="true">
            <form id="search">
              <div class="form" data-bs-theme="light">
                <div class="input-group mb-3">
                  <input type="search" class="form-control" id="search-input" placeholder="위치, 매장명, 주소 검색">
                  <button class="btn btn-warning" id="search-button">검색</button>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="" id="defaultCheck1" disabled>
                  <label class="form-check-label" for="defaultCheck1">
                    현재위치 켜기
                  </label>
                </div>
              </div>
            </form>
          </li>
          <li id="result-counter-text" class="list-group-item fw-bold">
            검색결과 0곳
          </li>
        </ul>
      </div>
      <div class="col-sm">
        <div id="map" class="rounded"></div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="container-fluid">
    <footer class="py-3 my-4">
      <ul class="nav justify-content-center border-bottom pb-3 mb-3">
        <li class="nav-item"><a href="#" class="nav-link px-2 text-muted">Home</a></li>
        <li class="nav-item"><a href="#" class="nav-link px-2 text-muted">Features</a></li>
        <li class="nav-item"><a href="#" class="nav-link px-2 text-muted">Pricing</a></li>
        <li class="nav-item"><a href="#" class="nav-link px-2 text-muted">FAQs</a></li>
        <li class="nav-item"><a href="#" class="nav-link px-2 text-muted">About</a></li>
      </ul>
      <p class="text-center text-muted">Twitter @tak_0_dachi</p>
    </footer>
  </div>


  <!-- Login Modal -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-2" id="loginModalLabel">로그인</h1>
        </div>
        <div class="modal-body">
          <form class="row g-3">
            <div class="mb-3">
              <label for="inputID" class="form-label">아이디</label>
              <input type="text" class="form-control" id="inputID" aria-describedby="emailHelp">
            </div>
            <div class="mb-3">
              <label for="inputPW" class="form-label">Password</label>
              <input type="password" class="form-control" id="inputPW">
            </div>
            <button type="submit" class="btn btn-primary">로그인</button>
            <button type="button" class="btn btn-link" style="text-decoration: none" href="applyUrl"
              data-bs-toggle="modal" data-bs-target="#applyModal">회원가입</a>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Apply Modal -->
  <div class="modal fade" id="applyModal" tabindex="-1" aria-labelledby="applymodalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-2" id="applyModalLabel">회원가입</h1>
        </div>
        <div class="modal-body">
          <form class="row g-3">
            <div class="col-md-6">
              <label for="inputID" class="form-label">아이디</label>
              <input type="text" class="form-control" id="applyID">
            </div>
            <div class="col-md-6">
              <label for="inputPW" class="form-label">비밀번호</label>
              <input type="password" class="form-control" id="applyPW">
            </div>
            <div class="col">
              <label for="inputEmail" class="form-label">이메일</label>
              <input type="email" class="form-control" id="applyEmail">
            </div>
            <button type="submit" class="btn btn-primary">회원가입</button>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Shop Info Modal -->
  <div class="modal fade" id="shopModal" tabindex="-1" aria-labelledby="shopModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <div style="flex-direction:column;">
            <h1 class="modal-title fs-2" id="shopModalLabel">
              (가게 네임)
            </h1>
            <a id="address" style="text-decoration: none" target='_blank'>가게주소</a>
          </div>
        </div>
        <div class="modal-body container">
          <div class="row">
            <div class="col-sm-8">
              <h3 class="fs-5">영업시간</h3>
              <p id="worktime">(영업시간)</p>
              <hr>
              <h3 class="fs-5">연락처</h3>
              <p id="contact">(연락처)</p>
              <hr>
              <h3 class="fs-5">가게정보</h3>
              <p id="content">(가게정보)</p>
              <p id="shoptype">(가게종류)</p>
            </div>
            <div class="col-sm-4" id="twitter-area">
              <div class="d-flex justify-content-center">
                <div class="spinner-border text-primary" id="twitter-loading" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
              <div id="twitter">
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 데이터 처리를 위한 변수 세팅 -->
  <script>
    const shopTypeMap = new Map([
      [1, '카페'],
      [2, '서점'],
      [3, '오락실'],
      [4, '굿즈샵'],
      [5, '식당'],
      [6, '게임샵']
    ]);

  </script>

  <!-- kakao Map Setting -->
  <script>
    // 카카오맵 로딩
    var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
      mapOption = {
        center: new kakao.maps.LatLng(35.7, 127), // 지도의 중심좌표
        level: 13 // 지도의 확대 레벨
      };

    // 지도를 표시할 div와  지도 옵션으로  지도를 생성합니다
    var map = new kakao.maps.Map(mapContainer, mapOption),
      customOverlay = new kakao.maps.CustomOverlay({}),
      infowindow = new kakao.maps.InfoWindow({ removable: true });; //지도 생성 및 객체 리턴

    // 지도 확대 축소를 제어할 수 있는  줌 컨트롤을 생성합니다
    var zoomControl = new kakao.maps.ZoomControl();
    map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);
  </script>

  <!-- kakao Map Marker Setting -->
  <script>
    // 카카오 마커 세팅 함수
    function kakaoMapMarkerSetting() {

      // Shop검색결과 개수
      const shopListSize = shopLocations.length;
      const shopListSizeText = document.querySelector('#result-counter-text');
      shopListSizeText.innerText = "검색결과 " + shopListSize + "곳";

      shopLocations.map(shop => {

        // 마커를 생성합니다
        var marker = new kakao.maps.Marker({
          map: map, // 마커를 표시할 지도
          position: shop.latlng// 마커의 위치
        });

        // 마커에 표시할 인포윈도우를 생성합니다 
        var infowindow = new kakao.maps.InfoWindow({
          content: shop.content // 인포윈도우에 표시할 내용
        });

        // 샵 데이터 가져오기 
        const shopName = shop.name;
        const shopData = shopList.get(shopName);

        // 마커와 샵 리스트 연결

        // 마커에 mouseover 이벤트와 mouseout 이벤트를 등록합니다
        // 이벤트 리스너로는 클로저를 만들어 등록합니다 
        (function (marker, infowindow) {
          // 마커에 mouseover 이벤트를 등록하고 마우스 오버 시 인포윈도우를 표시합니다 
          kakao.maps.event.addListener(marker, 'mouseover', function () {
            infowindow.open(map, marker);
          });

          // 마커에 mouseout 이벤트를 등록하고 마우스 아웃 시 인포윈도우를 닫습니다
          kakao.maps.event.addListener(marker, 'mouseout', function () {
            infowindow.close();
          });

          // 마커에 click 이벤트를 등록하고 Modal 띄우기
          kakao.maps.event.addListener(marker, 'click', function () {

            // Modal 열기
            const shopModal = new bootstrap.Modal('#shopModal');
            shopModal.show();

            // 트위터 로딩 엘리먼트 선언
            const twitterLoadingElement = document.getElementById("twitter-loading");
            twitterLoadingElement.style.display = "block";

            // 데이터를 넣을 element 객체 가져오기
            const modalText = document.querySelector('#modal-text');
            const modalLabel = document.querySelector('#shopModalLabel');
            const addressText = document.querySelector('#address');
            const contactText = document.querySelector('#contact');
            const workTimeText = document.querySelector('#worktime');
            const contentText = document.querySelector('#content');
            const shopTypeText = document.querySelector('#shoptype');

            // 데이터 변경
            modalLabel.innerText = shopName;
            addressText.innerText = shopData.address;
            contactText.innerText = shopData.contact;
            workTimeText.innerText = shopData.workTime;
            contentText.innerText = shopData.content;

            // 카카오 주소 링크 설정
            const addressLink = 'https://map.kakao.com/?' + 'urlX=' + marker.n.La + '&urlY=' + marker.n.Ma + '&name=' + shopName;
            addressText.setAttribute('href', addressLink);

            // 데이터 변경 -> 샵 종류 데이터 처리
            let shoptype = '';
            shopData.shopType.map(type => {
              shoptype += '#' + shopTypeMap.get(type) + ' ';
            })
            shopTypeText.innerText = shoptype;

            // Twitter 타임라인 만들기
            const twitterId = shopData.twitter.slice(20);
            twttr.widgets.createTimeline(
              {
                sourceType: "profile",
                screenName: twitterId,
              },
              document.getElementById("twitter"),
              {
                height: 500,
                tweetLimit: 5
              }
            ).then(
              function () {
                twitterLoadingElement.style.display = "none";
              }
            );

            // Modal이 닫혔을 경우에 대한 처리
            const shopModalElement = document.getElementById('shopModal')
            shopModalElement.addEventListener('hide.bs.modal', () => {
              const twitterElement = document.querySelector('#twitter');
              twitterElement.innerHTML = "";
            });
          });

        })(marker, infowindow);
      });
    }
  </script>

  <!-- Server Request -->
  <script>
    const ip = 'http://127.0.0.1:8000/v1/shop/';
    const shopList = new Map();
    const shopLocations = [];

    // 요청 핸들링
    function handleResponse(response) {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    }

    // 성공 핸들링
    function handleData(data) {
      data.map(data => {
        const shopName = data.name;
        const shopId = data.id;

        const li = document.createElement("li");
        li.setAttribute('id', shopId);
        li.setAttribute('class', 'list-group-item list-group-item-action');

        const textNode = document.createTextNode(shopName);
        li.appendChild(textNode)

        document.getElementById('shop-list').appendChild(li);
        shopList.set(data.name, data)
        shopLocations.push(
          {
            name: shopName,
            content: '<div class="info-window" style="width: 18rem; background: white">' +
              '<div class="card-body">' +
              '<h5 class="card-title fs-4">' +
              shopName +
              '</h5>' +
              '<p class="card-text text-primary">' +
              data.address +
              '</p>' +
              '<div class="card-footer">' +
              '아래의 마커를 클릭하여 상세정보 열기' +
              '</div>' +
              '</div>',
            latlng: new kakao.maps.LatLng(data.y, data.x)
          }
        )
      });
    }

    // 에러 핸들링
    function handleError(error) {
      alert(error);
    }
  </script>

  <!--RUN Function-->
  <script>
    Promise.all([
      fetch(ip)
        .then(handleResponse)
        .then(handleData)
        .catch(handleError)],
    ).then(kakaoMapMarkerSetting)
  </script>
</body>

</html>